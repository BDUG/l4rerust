local L4 = require("L4")
local ld = L4.default_loader

-- allocate a communication channel for the filesystem server
local fs_chan = ld:new_channel()

-- allocate a communication channel for the network server
local net_chan = ld:new_channel()

-- start the file system server with the required capabilities so it can
-- access the virtio block device and publish its IPC gate as "global_fs"
ld:start({
  log = {"fs_server", "green"},
  caps = {
    -- server side of the global filesystem gate
    global_fs = fs_chan:svr(),
    -- grant access to the virtio block device and its interrupt
    virtio_blk = L4.Env.virtio_blk,
    virtio_blk_irq = L4.Env.virtio_blk_irq,
    -- allow mapping of IO memory and scheduling
    iomem = L4.Env.sigma0,
    scheduler = L4.Env.sched,
  }
}, "rom/fs_server")

-- start the network server and publish its IPC gate as "global_net"
ld:start({
  log = {"net_server", "blue"},
  caps = {
    -- server side of the global network gate
    global_net = net_chan:svr(),
    -- grant access to the virtio network device and its interrupt
    virtio_net = L4.Env.virtio_net,
    virtio_net_irq = L4.Env.virtio_net_irq,
    -- allow mapping of IO memory and scheduling
    iomem = L4.Env.sigma0,
    scheduler = L4.Env.sched,
  }
}, "rom/net_server")

-- launch bash afterwards. The client side of the global_fs channel is passed
-- so programs can look it up from their environment and talk to the servers.
ld:start({
  log = {"bash", "yellow"},
  caps = { global_fs = fs_chan, global_net = net_chan }
}, "rom/bash")

