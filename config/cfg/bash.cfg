local L4 = require("L4")
local ld = L4.default_loader

-- Allocate communication channels for system-wide services
local fs_chan = ld:new_channel()
local net_chan = ld:new_channel()
local lsb_root = ld:new_channel()

-- Start systemd (/sbin/init) and export capability handles so that
-- it can launch the actual servers and clients.
ld:start({
  log = {"init", "yellow"},
  caps = {
    -- server side of the global filesystem gate
    global_fs = fs_chan:svr(),
    -- server side of the global network gate
    global_net = net_chan:svr(),
    -- server side of the LSB root gate
    lsb_root = lsb_root:svr(),
    -- provide hardware device and kernel interfaces for services
    virtio_blk = L4.Env.virtio_blk,
    virtio_blk_irq = L4.Env.virtio_blk_irq,
    virtio_net = L4.Env.virtio_net,
    virtio_net_irq = L4.Env.virtio_net_irq,
    iomem = L4.Env.sigma0,
    scheduler = L4.Env.sched,
  }
}, "/sbin/init")
